services:
  pg:
    image: postgres:16
    container_name: korm-testing-pg
    environment:
      POSTGRES_USER: ${KORM_TESTING_PG_USER:-korm}
      POSTGRES_PASSWORD: ${KORM_TESTING_PG_PASSWORD:-korm}
      POSTGRES_DB: ${KORM_TESTING_PG_DB:-korm}
    ports:
      - "${KORM_TESTING_PG_PORT:-15432}:5432"
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}
      interval: 2s
      timeout: 5s
      retries: 20
    volumes:
      - korm-testing-pg:/var/lib/postgresql/data

  mysql:
    image: mysql:8.0
    container_name: korm-testing-mysql
    command:
      - --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${KORM_TESTING_MYSQL_ROOT_PASSWORD:-korm-root}
      MYSQL_DATABASE: ${KORM_TESTING_MYSQL_DB:-default}
      MYSQL_USER: ${KORM_TESTING_MYSQL_USER:-korm}
      MYSQL_PASSWORD: ${KORM_TESTING_MYSQL_PASSWORD:-korm}
    ports:
      - "${KORM_TESTING_MYSQL_PORT:-13306}:3306"
    healthcheck:
      test:
        - CMD-SHELL
        - mysqladmin ping -h 127.0.0.1 -u$${MYSQL_USER} -p$${MYSQL_PASSWORD}
      interval: 2s
      timeout: 5s
      retries: 20
    volumes:
      - korm-testing-mysql:/var/lib/mysql

  minio:
    image: minio/minio:latest
    container_name: korm-testing-minio
    command:
      - server
      - /data
      - --console-address
      - ":9001"
    environment:
      MINIO_ROOT_USER: ${KORM_TESTING_S3_ACCESS_KEY_ID:-korm}
      MINIO_ROOT_PASSWORD: ${KORM_TESTING_S3_SECRET_ACCESS_KEY:-kormpass}
    ports:
      - "${KORM_TESTING_S3_PORT:-19000}:9000"
      - "${KORM_TESTING_S3_CONSOLE_PORT:-19001}:9001"
    volumes:
      - korm-testing-minio:/data

volumes:
  korm-testing-pg:
  korm-testing-mysql:
  korm-testing-minio:
